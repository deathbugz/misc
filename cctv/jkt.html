<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live CCTV Monitor - Molecool</title>
    <!-- Menggunakan Tailwind CSS untuk styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Gaya tambahan untuk tampilan yang lebih baik */
        body {
            font-family: 'Inter', sans-serif;
        }
        #loader-initial {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3b82f6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        #loader-update {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #10b981;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1.5s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Styling untuk gambar hasil */
        .cctv-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease, opacity 0.5s ease;
            animation: fadeIn 0.5s ease-out;
        }
        .cctv-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.15);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div class="w-full max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        
        <header class="mb-6 flex justify-between items-center flex-wrap gap-4">
            <div>
                <h1 id="main-title" class="text-3xl font-bold text-white">Live CCTV Monitor</h1>
                <p class="text-gray-400">Menampilkan feed dari <a href="https://molecool.id/live-cctv/" target="_blank" class="text-blue-400 hover:underline">molecool.id/live-cctv</a> (via My Proxy)</p>
            </div>
            <div id="status-container" class="text-right">
                <div class="flex items-center gap-3 justify-end">
                    <div id="status-indicator" class="flex items-center gap-2">
                        <!-- Loader atau status akan muncul di sini -->
                    </div>
                    <button id="manual-update-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-lg text-sm transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex-shrink-0">
                        Update Now
                    </button>
                </div>
                <div class="text-xs text-gray-500 mt-2">
                     <span id="last-updated"></span>
                     <!-- Countdown Timer -->
                     <span id="countdown-timer" class="ml-2 font-mono"></span>
                </div>
            </div>
        </header>

        <!-- Output Area for Images -->
        <div id="output" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 min-h-[50vh]">
            <!-- Kartu CCTV akan ditampilkan di sini -->
        </div>
    </div>

    <script>
        const outputElement = document.getElementById('output');
        const statusIndicator = document.getElementById('status-indicator');
        const lastUpdatedElement = document.getElementById('last-updated');
        const countdownElement = document.getElementById('countdown-timer');
        const manualUpdateBtn = document.getElementById('manual-update-btn');
        const mainTitle = document.getElementById('main-title');

        const TARGET_URL = "https://molecool.id/live-cctv/";
        const REFRESH_INTERVAL_MS = 60000;

        const displayedCCTVs = {};
        let isFetching = false;
        let countdownInterval;
        let autoFetchInterval;
        let imageRefreshInterval; 

        const updateTitleCount = () => {
            const count = Object.keys(displayedCCTVs).length;
            mainTitle.textContent = `Live CCTV Monitor (${count})`;
        };

        const formatTime = (date) => date.toLocaleTimeString('en-GB', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            timeZone: 'Asia/Jakarta',
            timeZoneName: 'short'
        }).replace('GMT+7', 'WIB');

        const startCountdown = () => {
            clearInterval(countdownInterval);
            let timeLeft = REFRESH_INTERVAL_MS / 1000;
            
            countdownElement.textContent = `(next update in ${timeLeft}s)`;

            countdownInterval = setInterval(() => {
                timeLeft--;
                if (timeLeft >= 0) {
                    countdownElement.textContent = `(next update in ${timeLeft}s)`;
                } else {
                    clearInterval(countdownInterval);
                }
            }, 1000);
        };
        
        const renderSortedCCTVs = () => {
            const cctvArray = Object.values(displayedCCTVs);

            cctvArray.sort((a, b) => {
                return a.title.localeCompare(b.title);
            });

            outputElement.innerHTML = '';

            cctvArray.forEach(cctv => {
                outputElement.appendChild(cctv.element);
            });
            
            updateTitleCount(); // Perbarui jumlah di judul
        };

        const refreshAllImages = () => {
            console.log("Refreshing all visible CCTV images...");
            const now = Date.now();
            for (const cctv of Object.values(displayedCCTVs)) {
                const imgElement = cctv.element.querySelector('img');
                if (imgElement) {
                    let originalUrl = cctv.imageUrl.split('&_cacheBust=')[0];
                    imgElement.src = `${originalUrl}&_cacheBust=${now}`;
                }
            }
        };

        const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        const fetchAndProcessCCTVs = async () => {
            if (isFetching) return { imagesProcessed: 0, success: false };
            isFetching = true;
            manualUpdateBtn.disabled = true;
            if (!document.body.classList.contains('initial-loading')) {
                 statusIndicator.innerHTML = '<div id="loader-update"></div> <span class="text-gray-400">Memeriksa pembaruan...</span>';
            }
            
            // ===== GANTI URL DI SINI =====
            // Ganti URL ini dengan URL Cloudflare Worker Anda
            const MY_PROXY_URL = "https://tad-gas-dark-base-b341.ta-danial.workers.dev/"; 
            const proxyUrl = `${MY_PROXY_URL}/?quest=${encodeURIComponent(TARGET_URL)}`;
            // =============================

            const fetchTime = new Date();
            let imagesProcessed = 0;
            let success = false;

            try {
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error(`Network response was not ok. Status: ${response.status}`);
                
                const htmlContent = await response.text();
                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlContent, 'text/html');

                const imageElements = doc.querySelectorAll('img[src*="preview.jpg"][src*="token="]');
                let newImagesFound = 0;
                
                imageElements.forEach(imgElement => {
                    imagesProcessed++;
                    const imageUrl = imgElement.src;
                    const parentLink = imgElement.closest('a');
                    const liveUrl = parentLink ? parentLink.href : '#';
                    let title = 'Judul tidak ditemukan';

                    try {
                        const urlParts = imageUrl.split('/');
                        if (urlParts.length > 2) {
                            const titlePart = urlParts[urlParts.length - 2]; 
                            title = titlePart.replace(/-/g, ' ');
                        }
                    } catch (e) {
                        console.warn("Could not parse title from URL:", imageUrl, e);
                    }

                    if (title === 'Judul tidak ditemukan') return;

                    if (!displayedCCTVs[title]) {
                        newImagesFound++;
                        const cardElement = createCCTVCard(imageUrl, title, fetchTime, liveUrl);
                        displayedCCTVs[title] = {
                            title: title,
                            imageUrl: imageUrl,
                            liveUrl: liveUrl,
                            element: cardElement,
                            lastSeen: fetchTime
                        };
                    } else {
                        const existingCCTV = displayedCCTVs[title];
                        existingCCTV.lastSeen = fetchTime;
                        existingCCTV.imageUrl = imageUrl;
                        existingCCTV.liveUrl = liveUrl;

                        const timeElement = existingCCTV.element.querySelector('.last-seen-time');
                        if(timeElement) timeElement.textContent = formatTime(fetchTime);
                        const img = existingCCTV.element.querySelector('img');
                        if (img && img.src !== imageUrl) img.src = imageUrl;
                        const link = existingCCTV.element.querySelector('a');
                        if (link && link.href !== imageUrl) link.href = imageUrl; // Updates the image link
                        const liveLink = existingCCTV.element.querySelector('.live-link');
                        if (liveLink && liveLink.href !== liveUrl) liveLink.href = liveUrl; // Updates the "open live" link
                    }
                });

                renderSortedCCTVs();
                success = true;
                
                if (!document.body.classList.contains('initial-loading')) {
                    if (imagesProcessed === 0) {
                        statusIndicator.innerHTML = `<span class="text-yellow-400 font-semibold">!</span> <span class="text-gray-300">Tidak ada gambar CCTV ditemukan.</span>`;
                    } else {
                        const statusText = newImagesFound > 0 ? `${newImagesFound} CCTV baru!` : 'Tidak ada CCTV baru.';
                        statusIndicator.innerHTML = `<span class="text-green-400 font-semibold">✔</span> <span class="text-gray-300">${statusText}</span>`;
                    }
                }

            } catch (error) {
                console.error("Fetch error:", error);
                 if (!document.body.classList.contains('initial-loading')) {
                    let errorMessage = "Gagal memperbarui (Masalah Jaringan/Proxy).";
                    statusIndicator.innerHTML = `<span class="text-red-500 font-semibold">✖</span> <span class="text-gray-300">${errorMessage}</span>`;
                }
            } finally {
                isFetching = false;
                manualUpdateBtn.disabled = false;
                if (!document.body.classList.contains('initial-loading')) {
                    lastUpdatedElement.textContent = `Pembaruan terakhir: ${formatTime(fetchTime)}`;
                    if (Object.keys(displayedCCTVs).length > 0) startCountdown();
                }
            }
            return { imagesProcessed, success };
        };

        const createCCTVCard = (imageUrl, title, time, liveUrl) => {
            const card = document.createElement('div');
            card.className = 'cctv-card bg-gray-800 rounded-lg shadow-lg overflow-hidden flex flex-col';
            
            card.innerHTML = `
                <a href="${imageUrl}" target="_blank">
                    <img src="${imageUrl}" alt="${title}" class="w-full h-40 object-cover" loading="lazy">
                </a>
                <div class="p-4 flex-grow flex flex-col justify-between">
                    <div>
                        <div class="flex justify-between items-start mb-2">
                            <h5 class="font-bold text-sm text-white leading-tight">${title}</h5>
                            <a href="${liveUrl}" target="_blank" class="live-link text-xs text-blue-400 hover:underline flex-shrink-0 ml-2">open live</a>
                        </div>
                    </div>
                    <p class="text-xs text-gray-400">
                        last open: <span class="font-medium text-gray-300 last-seen-time">${formatTime(time)}</span>
                    </p>
                </div>
            `;
            
            const img = card.querySelector('img');
            img.onerror = () => {
                console.warn(`Gambar gagal dimuat (URL expired?), menghapus: ${title}`);
                card.style.opacity = '0';
                setTimeout(() => {
                    card.remove();
                    delete displayedCCTVs[title];
                    updateTitleCount(); // Perbarui jumlah setelah menghapus
                }, 500);
            };
            return card;
        };
        
        const triggerManualUpdate = () => {
            if (isFetching) return;
            console.log("Manual update triggered.");
            clearInterval(autoFetchInterval);
            clearInterval(countdownInterval);
            countdownElement.textContent = ''; 
            fetchAndProcessCCTVs().finally(() => {
                console.log("Manual update finished. Restarting auto-fetch timer.");
                autoFetchInterval = setInterval(fetchAndProcessCCTVs, REFRESH_INTERVAL_MS);
            });
        };

        const initialFetchCollector = async () => {
            const INITIAL_FETCH_COUNT = 10;
            const FETCH_DELAY_MS = 5000;
            document.body.classList.add('initial-loading');

            for (let attempt = 1; attempt <= INITIAL_FETCH_COUNT; attempt++) {
                statusIndicator.innerHTML = `<div id="loader-update"></div> <span class="text-gray-400">Mengumpulkan feed... (${attempt}/${INITIAL_FETCH_COUNT})</span>`;
                
                console.log(`Initial data gathering, run #${attempt}...`);
                await fetchAndProcessCCTVs();

                if (attempt < INITIAL_FETCH_COUNT) {
                    await delay(FETCH_DELAY_MS);
                }
            }
            
            document.body.classList.remove('initial-loading');
            console.log("Initial data gathering complete.");

            if (Object.keys(displayedCCTVs).length === 0) {
                console.error("Gagal menemukan CCTV setelah semua percobaan.");
                statusIndicator.innerHTML = `<span class="text-red-500 font-semibold">✖</span> <span class="text-gray-300">Gagal memuat feed awal.</span>`;
            } else {
                console.log("Starting periodic updates.");
                await fetchAndProcessCCTVs();
                autoFetchInterval = setInterval(fetchAndProcessCCTVs, REFRESH_INTERVAL_MS);
                imageRefreshInterval = setInterval(refreshAllImages, REFRESH_INTERVAL_MS);
            }
        };

        manualUpdateBtn.addEventListener('click', triggerManualUpdate);

        initialFetchCollector();
    </script>
</body>
</html>
